<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaufland Route List</title>
<style>
/* =========================================================
   NEON DARK THEME (with light variant)
   - Accent: hot pink
   - Dark-first design; soft glass, rounded, high contrast
   - Force theme by adding data-theme="dark" | "light" to <html>
   ========================================================= */

/* ---------- Shared tokens ---------- */
:root{
  --radius: 16px;
  --pad: 14px;

  --primary: #ff007f;          /* hot pink */
  --on-primary: #ffffff;

  /* defaults = LIGHT; overridden below for dark/auto-dark */
  --bg: #f7f7fb;
  --surface: #ffffff;
  --text: #111318;

  --muted: #5f6675;
  --border: #e5e7eb;
  --chip: #f2f3f6;
  --chip-border: #e6e7ef;

  --hover: rgba(0,0,0,.04);
  --press: rgba(0,0,0,.08);

  --shadow-sm: 0 6px 18px rgba(0,0,0,.06);
  --shadow-md: 0 12px 36px rgba(0,0,0,.12);

  /* focus */
  --ring: 0 0 0 3px color-mix(in oklab, var(--primary) 32%, transparent);
}

/* ---------- Auto dark (when you don't force a theme) ---------- */
@media (prefers-color-scheme: dark){
  :root:not([data-theme]){
    --bg: #0f0f12;
    --surface: #17171c;
    --text: #e8e9ee;

    --muted: #a5adbb;
    --border: #2a2a33;
    --chip: #1f1f25;
    --chip-border: #2a2a33;

    --hover: rgba(255,255,255,.06);
    --press: rgba(255,255,255,.10);

    --shadow-sm: 0 10px 28px rgba(0,0,0,.35);
    --shadow-md: 0 18px 48px rgba(0,0,0,.45);
  }
}

/* ---------- Manual overrides ---------- */
:root[data-theme="light"]{
  --bg: #f7f7fb;
  --surface: #ffffff;
  --text: #111318;

  --muted: #5f6675;
  --border: #e5e7eb;
  --chip: #f2f3f6;
  --chip-border: #e6e7ef;

  --hover: rgba(0,0,0,.04);
  --press: rgba(0,0,0,.08);

  --shadow-sm: 0 6px 18px rgba(0,0,0,.06);
  --shadow-md: 0 12px 36px rgba(0,0,0,.12);
}
:root[data-theme="dark"]{
  --bg: #0f0f12;
  --surface: #17171c;
  --text: #e8e9ee;

  --muted: #a5adbb;
  --border: #2a2a33;
  --chip: #1f1f25;
  --chip-border: #2a2a33;

  --hover: rgba(255,255,255,.06);
  --press: rgba(255,255,255,.10);

  --shadow-sm: 0 10px 28px rgba(0,0,0,.35);
  --shadow-md: 0 18px 48px rgba(0,0,0,.45);
}

/* =========================================================
   Base
   ========================================================= */
*{ box-sizing: border-box; }
:root{ color-scheme: light dark; }

body{
  margin:0;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans';
}

.wrap{ max-width: 900px; margin: 0 auto; padding: 14px; }
h1{ font-size: 20px; margin: 6px 0 2px; }

header{
  position: sticky; top: 0; z-index: 5;
  background: color-mix(in oklab, var(--surface) 90%, transparent);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
}

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }

/* =========================================================
   Controls
   ========================================================= */
input[type="text"], input[type="number"], input[type="file"], select{
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  outline: none;
  transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
}
input[type="text"]:focus, input[type="number"]:focus, select:focus{
  border-color: color-mix(in oklab, var(--primary) 55%, var(--border));
  box-shadow: var(--ring);
}
input[type="number"]{ width: 110px; }

button{
  padding: 10px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: background .12s ease, transform .06s ease, border-color .12s ease, box-shadow .12s ease;
}
button:hover{ background: color-mix(in oklab, var(--surface), var(--hover)); }
button:active{ background: color-mix(in oklab, var(--surface), var(--press)); transform: translateY(1px); }

button.primary{
  background: var(--primary);
  color: var(--on-primary);
  border-color: var(--primary);
  box-shadow: 0 12px 30px color-mix(in oklab, var(--primary) 30%, transparent);
}

/* Pills / chips */
.pill{
  padding: 6px 12px; border-radius: 999px;
  background: var(--chip);
  border: 1px solid var(--chip-border);
  font-size: 12px;
  color: var(--text);
}
.muted{ color: var(--muted); font-size: 13px; }

/* =========================================================
   Cards, toolbars, tabs
   ========================================================= */
.card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--pad);
  box-shadow: var(--shadow-md);
}

.toolbar{ display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
.toolbar .group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

/* Sticky sub-toolbar inside cards */
.card > .toolbar{
  position: sticky;
  top: calc(env(safe-area-inset-top, 0px) + 64px);
  z-index: 3;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 8px 0;
}

/* Tabs */
.tabs{ display:flex; gap:10px; }
.tab{
  padding: 8px 16px;
  border-radius: 999px;
  border: 1px solid var(--chip-border);
  background: var(--chip);
  color: var(--text);
  transition: background .12s ease, box-shadow .12s ease, border-color .12s ease, transform .06s ease;
}
.tab:hover{ background: color-mix(in oklab, var(--chip), var(--hover)); }
.tab.active{
  background: var(--primary);
  border-color: var(--primary);
  color: var(--on-primary);
  box-shadow: 0 14px 36px color-mix(in oklab, var(--primary) 30%, transparent);
}
/* =========================================================
   Bottom Navigation
   ========================================================= */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0; right: 0;
  display: flex;
  gap: 8px;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
  background: var(--surface);
  border-top: 1px solid var(--border);
  box-shadow: 0 -8px 24px rgba(0,0,0,.12);
  z-index: 9999;           /* ↑ ensure it sits on top of footer/overlays */
  pointer-events: auto;
}

.bottom-nav .tab {
  flex: 1;
  text-align: center;
  padding: 12px 0;
  border-radius: 0;
  border: none;
  background: transparent;
  font-weight: 600;
}
.bottom-nav .tab.active {
  background: var(--primary);
  color: var(--on-primary);
  border-radius: 12px;
  margin: 0 4px;
}

/* =========================================================
   List + groups
   ========================================================= */
.list{ margin-top:10px; display:grid; gap:12px; }
.groupHeader{ display:flex; align-items:center; gap:10px; font-weight:700; padding:4px 2px 0; }
.groupHeader .dot{ width:8px; height:8px; border-radius:999px; background:#9aa3b2; }
.groupBox{ display:grid; gap:8px; }

/* =========================================================
   Item row
   ========================================================= */
.item{
  display:grid;
  grid-template-columns: 28px 1fr auto;
  grid-template-rows: auto auto;
  gap:10px 10px;
  align-items:center;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:14px;
  background: var(--surface);
  transition: transform .06s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
}
.item.is-pressed{ transform: scale(.995); box-shadow: 0 8px 24px rgba(0,0,0,.25); }

.left{ grid-column:1; grid-row:1; display:flex; align-items:center; justify-content:center; }
.item input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--primary); }

.line1{
  grid-column:2; grid-row:1;
  font-size:16px; font-weight:800; line-height:1.25;
  overflow:hidden; white-space:nowrap; text-overflow:ellipsis; min-width:0;
}
.line1 .sep{ opacity:.7; font-weight:600; }

.actions{ grid-column:3; grid-row:1; display:flex; gap:8px; align-items:center; justify-self:end; }

.editbtn, .btn-icon{
  height:36px; padding:0 12px; border-radius:10px;
  border:1px solid var(--border);
  background: var(--surface);
  display:grid; place-items:center;
}

.icon{ width:18px; height:18px; display:inline-block; }

/* Below row (photo + notes) */
.below{
  grid-column:2 / 4; grid-row:2;
  display:grid; grid-template-columns:48px 1fr;
  align-items:center; column-gap:10px;
}
.below.hidden{ display:none; }

.thumb{
  width:44px; height:44px; border-radius:12px; object-fit:cover;
  border:1px solid var(--border); background:#2a2a33; display:block; cursor:pointer;
}
.camBtn{
  width:44px; height:44px; border-radius:12px;
  border:1px dashed var(--border);
  display:flex; align-items:center; justify-content:center;
  background: var(--surface);
  cursor:pointer; padding:0;
}

.line2{ color: var(--muted); font-size:14px; line-height:1.35; white-space:normal; overflow-wrap:anywhere; }
.line2:empty{ display:none; }

/* Category dots (kept from your schema) */
.catdot{ width:8px; height:8px; border-radius:999px; display:inline-block; margin-right:8px; background:#7b8497; vertical-align:middle; }
.item[data-cat="produce"] .catdot{ background:#2fb344; }
.item[data-cat="meat-poultry"] .catdot{ background:#d7263d; }
.item[data-cat="fish-seafood"] .catdot{ background:#2a9df4; }
.item[data-cat="dairy-eggs"] .catdot{ background:#51b3ff; }
.item[data-cat="bakery"] .catdot{ background:#f08c2f; }
.item[data-cat="pantry"] .catdot{ background:#a1765c; }
.item[data-cat="frozen"] .catdot{ background:#27c3d6; }
.item[data-cat="beverages"] .catdot{ background:#7b61ff; }
.item[data-cat="snacks-confectionery"] .catdot{ background:#ffd43b; }
.item[data-cat="household-cleaning"] .catdot{ background:#8795a1; }
.item[data-cat="personal-care-health"] .catdot{ background:#ff6fa3; }
.item[data-cat="other"] .catdot{ background:#c0c4cc; }

/* Inline qty box inside title */
.qty-inline{
  width:80px; padding:6px 8px;
  border:1px solid var(--border);
  border-radius:10px; font:inherit;
  background: var(--surface);
  color: var(--text);
}

/* Editor row (expanded) */
.item .editor{ display:none; grid-column:1 / -1; }
.item.editing .editor{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:8px; padding-top:8px;
}
.qty, .size, .notes, .route, .category{ width:100%; }

@media (max-width:560px){
  .item.editing .editor{ grid-template-columns:1fr; }
  button, input, select{ min-height:44px; }
}

/* Checked effect */
.item:has(input[type="checkbox"]:checked){
  background:
    linear-gradient(0deg, color-mix(in oklab, var(--surface) 75%, var(--hover)), color-mix(in oklab, var(--surface) 75%, var(--hover))),
    var(--surface);
  opacity:.92;
}
.item:has(input[type="checkbox"]:checked) .line1{ text-decoration:line-through; color: color-mix(in oklab, var(--text) 60%, #888); }

/* =========================================================
   Autocomplete / Toast / Popups / Modals / Lightbox
   (restyled to match neon-dark)
   ========================================================= */
.ac-list{
  position:absolute; left:0; right:0; top:100%; margin-top:6px;
  background: var(--surface);
  border:1px solid var(--border);
  border-radius:14px; box-shadow: var(--shadow-md);
  max-height:280px; overflow:auto; z-index:6;
}
.ac-item{ display:flex; flex-direction:column; gap:2px; padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border); }
.ac-item:last-child{ border-bottom:none; }
.ac-item:hover{ background: color-mix(in oklab, var(--surface), var(--hover)); }
.ac-title{ font-weight:700; }
.ac-meta{ color: var(--muted); font-size:12px; }

.toast{
  position: fixed; left:50%;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 18px);
  transform: translateX(-50%) translateY(20px);
  opacity:0; transition: transform .18s ease, opacity .18s ease;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius:14px; box-shadow: var(--shadow-md);
  padding:10px 14px; font-size:14px; pointer-events:none; z-index:50;
}
.toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

.popup-backdrop{ position:fixed; inset:0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:90; }
.popup-backdrop.show{ display:flex; }
.popup{
  background: var(--surface);
  border:1px solid var(--chip-border);
  border-radius:16px; width:300px; padding:12px; box-shadow: var(--shadow-md);
}
.popup h3{ margin:6px 8px 10px; font-size:15px; }
.popup .choices{ display:grid; gap:8px; }
.popup .choices button{ width:100%; }

.modal{ position:fixed; inset:0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:80; }
.modal.show{ display:flex; }
.modal-card{
  width:min(740px,95vw);
  background: var(--surface);
  border:1px solid var(--border);
  border-radius:18px; box-shadow: var(--shadow-md);
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); }
.modal-body{ padding:14px 16px; max-height:65vh; overflow:auto; display:grid; gap:10px; }
.modal-foot{ padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; }

.input-row{ display:grid; gap:8px; grid-template-columns: 1fr 160px; }
@media (max-width:560px){ .input-row{ grid-template-columns:1fr; } }

.tag-row{ display:flex; flex-wrap:wrap; gap:8px; }
.tagchip{
  padding:6px 10px; border:1px solid var(--chip-border); border-radius:999px; cursor:pointer; user-select:none;
  background: var(--chip); color: var(--text);
}
.tagchip.active{ background: var(--primary); color: var(--on-primary); border-color: var(--primary); }

.preset-row{ display:flex; gap:8px; flex-wrap:wrap; }
.preset{ padding:6px 10px; border:1px solid var(--chip-border); border-radius:999px; background: var(--chip); }
.preset.active{ background: var(--primary); color: var(--on-primary); border-color: var(--primary); }

.checklist{ display:grid; gap:8px; }
.checkrow{
  display:grid; grid-template-columns:24px 1fr auto; align-items:center; gap:10px;
  border:1px solid var(--border); border-radius:12px; padding:8px 10px; background: var(--surface);
}

.step-row{ display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:start; }
.step-num{
  min-width:36px; height:36px; display:grid; place-items:center;
  border-radius:10px; background: var(--chip); border:1px solid var(--chip-border); font-weight:800;
}
.step-text{
  width:100%; min-height:48px;
  border:1px solid var(--chip-border);
  border-radius:12px; padding:8px 10px;
  background: var(--surface); color: var(--text);
}
  /* Reserve space so content isn't hidden behind the bottom nav */
body { padding-bottom: calc(70px + env(safe-area-inset-bottom)); }

/* =========================================================
   Bottom Navigation
   ========================================================= */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0; right: 0;
  display: flex;
  gap: 8px;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
  background: var(--surface);
  border-top: 1px solid var(--border);
  box-shadow: 0 -8px 24px rgba(0,0,0,.12);
  z-index: 100;
}
.bottom-nav .tab {
  flex: 1;
  padding: 12px 0;
  border-radius: 12px;
  border: 1px solid var(--chip-border);
  background: var(--chip);
  font-weight: 700;
}
.bottom-nav .tab:hover { background: color-mix(in oklab, var(--chip), var(--hover)); }
.bottom-nav .tab.active {
  background: var(--primary);
  border-color: var(--primary);
  color: var(--on-primary);
  box-shadow: 0 10px 24px color-mix(in oklab, var(--primary) 30%, transparent);
}

/* =========================================================
   Floating Theme Toggle (FAB)
   ========================================================= */
.theme-fab {
  position: fixed;
  right: 16px;
  bottom: calc(70px + 16px + env(safe-area-inset-bottom)); /* sits above the nav */
  border-radius: 999px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-md);
  cursor: pointer;
}
.theme-fab:hover  { background: color-mix(in oklab, var(--surface), var(--hover)); }
.theme-fab:active { background: color-mix(in oklab, var(--surface), var(--press)); transform: translateY(1px); }

</style>




  <!-- Firebase SDKs from CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <meta name="theme-color" content="#111"/>
  <link rel="manifest" href="manifest.webmanifest"/>
</head>
<body>
  <!-- SVG sprite -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 7h16"/><path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><path d="M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12"/><path d="M10 11v6M14 11v6"/>
    </symbol>
    <symbol id="i-cart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
    </symbol>
    <symbol id="i-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/>
      <circle cx="12" cy="13" r="4"/>
    </symbol>
  </svg>

  <header>
    <div class="wrap toolbar">
      <div class="group">
        <h1>🛒 Kaufland Route List</h1>
        <div id="householdTag" class="pill" title="Household code helps you both see the same list.">household: <span id="householdView">—</span></div>
      </div>
   


      <div id="authControls" class="group auth">

        <input id="household" placeholder="Household code (e.g., kino-ines)" />
        <button id="setHousehold">Set</button>
        <button id="signIn" class="primary">Sign in</button>
        <button id="signOut" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="status" class="status"></div>

    <section id="listSection" class="card">

      <div id="addRow" class="row">

                <div style="flex:2; min-width:220px; position:relative;">

          <label>Item</label>
          <input id="itemName" type="text" placeholder="e.g., Milch, Bananen" />
                            <div id="autoList" class="ac-list" role="listbox" aria-label="Suggestions" style="display:none"></div>
          <div id="updateTag" class="updateTag" style="display:none"></div>

        </div>
        <div>
          <label>Qty</label>
          <input id="itemQty" class="qty" type="text" placeholder="e.g., 2, 500g" />
        </div>
        <div style="min-width:120px;">
          <label>Size</label>
          <input id="itemSize" class="size" type="text" placeholder="e.g., 500g, 1L" />
        </div>
        <div style="min-width:180px;">
          <label>Category</label>
          <select id="itemCategory" class="category">
            <option value="">— Select —</option>
            <option>Produce</option><option>Meat & Poultry</option><option>Fish & Seafood</option>
            <option>Dairy & Eggs</option><option>Bakery</option><option>Pantry</option>
            <option>Frozen</option><option>Beverages</option><option>Snacks & Confectionery</option>
            <option>Household & Cleaning</option><option>Personal Care & Health</option><option>Other</option>
          </select>
        </div>
        <div style="min-width:120px;">
          <label>Route</label>
          <input id="itemRoute" class="route" type="number" step="0.1" placeholder="e.g., 12" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>Notes</label>
          <input id="itemNotes" class="notes" type="text" placeholder="e.g., brand, ripeness" />
        </div>

        <!-- ONE Add photo button + filename (new-item form) -->
        <div style="min-width:220px;">
          <label>Photo</label>
          <div class="row" style="gap:8px; align-items:center;">
            <button id="newItemAddPhoto" type="button">Add photo</button>
            <span id="photoName" class="muted"></span>
                        <img id="photoPreview" class="thumb" style="display:none" alt="Preview">

          </div>
        </div>

        <div><button id="add" class="primary">Add</button></div>
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <div class="group">
          <label>Sort by</label>
          <select id="sortMode">
            <option value="route">Route</option>
            <option value="category">Category</option>
          </select>
          <button id="clearChecked">Clear checked</button>
        </div>
        <div class="group" id="filterGroup">
  <label>Filter</label>
  <select id="filterMode">

            <option value="all">All</option>
            <option value="unchecked">Only unchecked</option>
            <option value="checked">Only checked</option>
            <option value="noroute">No route number</option>
          </select>
        </div>
      </div>

      <div id="list" class="list" aria-live="polite"></div>
      <div id="empty" class="empty" style="display:none">
        <svg class="icon" aria-hidden="true"><use href="#i-cart"></use></svg>
        <div class="headline">Your list is empty</div>
        <div class="muted">Add your first item above.</div>
      </div>
    </section>
<!-- ==================== Recipes View (shell) ==================== -->
<section id="recipesView" class="card" style="display:none; margin-top:14px;">
  <div class="toolbar" style="margin-top:0;">
    <div class="group">
      <h2 style="margin:0;">Recipes</h2>
      <span id="recipesCount" class="pill">0 recipes</span>
    </div>
    <div class="group">
      <input id="recipeSearch" placeholder="Search recipes…" />
      <button id="btnOpenAddRecipe" class="primary" type="button">Add Recipe</button>
    </div>
  </div>
  <div id="recipeList" class="list" style="margin-top:12px;"></div>
</section>

    <section id="howItWorks" class="card" style="margin-top:14px;">

      <strong>How it works</strong>
      <p>Use this app to keep a shared grocery list in sync. Make sure you are <em>signed in</em> and your <em>household code</em> matches. Add items, set their category/route once. Optionally attach a photo for brand/label. Tap a thumbnail to view it large.</p>
    </section>
  </main>

  <footer>Built for two awesome people.</footer>

  <!-- Global hidden file inputs (reused everywhere) -->
  <input id="fileChooser" type="file" accept="image/*" style="display:none" />
  <input id="fileCamera"  type="file" accept="image/*" capture="environment" style="display:none" />

  <!-- Small popup for photo choices -->
  <div id="photoPopup" class="popup-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="popup" role="document">
      <h3>Add a photo</h3>
      <div class="choices">
        <button id="ppTake"   type="button">📷 Take photo</button>
        <button id="ppChoose" type="button">🖼️ Choose photo</button>
        <button id="ppCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>
<!-- ==================== Recipe Editor Modal (shell) ==================== -->
<div id="recipeModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="rmTitle">
    <div class="modal-head">
      <h3 id="rmTitle" style="margin:0;">Add Recipe</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="rmDelete" class="danger" type="button" style="display:none">Delete</button>
        <button id="rmClose"  type="button">✕</button>
      </div>
    </div>
    <div class="modal-body">
      <!-- Meta -->
      <label>
        <div>Name</div>
        <input id="rmName" placeholder="e.g., Chicken Tikka" />
      </label>
      <div class="input-row">
        <label>
          <div>Base portions</div>
          <input id="rmBasePortions" type="number" min="1" value="2" />
        </label>
        <div>
          <div>Tags</div>
          <div id="rmTags" class="tag-row">
            <span class="tagchip" data-tag="vegan">vegan</span>
            <span class="tagchip" data-tag="quick">quick</span>
            <span class="tagchip" data-tag="dessert">dessert</span>
          </div>
        </div>
      </div>

      <!-- Cover photo -->
      <div>
        <div>Cover photo</div>
        <div class="row" style="gap:8px; align-items:center;">
          <button id="rmCoverBtn" type="button">Add/Change cover</button>
          <span id="rmCoverName" class="muted"></span>
          <img id="rmCoverPreview" class="thumb" style="display:none" alt="Cover preview">
          <button id="rmCoverRemove" type="button" style="display:none">Remove</button>
        </div>
      </div>

      <!-- Ingredients (just a placeholder list for now; full editor later) -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Ingredients</strong>
        <button id="rmAddIng" type="button">Add Ingredient</button>
      </div>
      <div id="rmIngList" class="checklist"></div>

      <!-- Steps (builder shell; full logic later) -->
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Steps</strong>
        <button id="rmAddStep" type="button">Add Step</button>
      </div>
      <div id="rmSteps" class="checklist"></div>
    </div>
    <div class="modal-foot">
      <div style="flex:1"></div>
      <button id="rmSave" class="primary" type="button">Save</button>
    </div>
  </div>
</div>

<!-- ==================== Add Recipe to List Modal (shell) ==================== -->
<div id="addToListModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="atlTitle">
    <div class="modal-head">
      <h3 id="atlTitle" style="margin:0;">Add Recipe to List</h3>
      <button id="atlClose" type="button">✕</button>
    </div>
    <div class="modal-body">
      <div>
        <div>Portions</div>
        <div class="row" style="gap:8px; align-items:center;">
          <button id="atlDec" type="button">–</button>
          <input id="atlServings" type="number" min="1" value="2" style="width:90px; text-align:center;">
          <button id="atlInc" type="button">+</button>
        </div>
        <div class="preset-row" style="margin-top:8px;">
          <button class="preset" data-x="1">1×</button>
          <button class="preset" data-x="1.5">1.5×</button>
          <button class="preset" data-x="2">2×</button>
        </div>
      </div>

      <label style="margin-top:8px;">
        <input type="checkbox" id="atlSelectAll" checked> Select/Deselect all
      </label>

      <div id="atlList" class="checklist"></div>
    </div>
    <div class="modal-foot">
      <div style="flex:1"></div>
      <button id="atlAdd" class="primary" type="button">Add to Shopping List</button>
    </div>
  </div>
</div>


  <script>
    // Register service worker for PWA installability
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>

  <script>
    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyAljIHyxs-pvJRi2pRzs2fsPARCQLFQ2Kg",
      authDomain: "grocery-list-77298.firebaseapp.com",
      projectId: "grocery-list-77298",
      storageBucket: "grocery-list-77298.firebasestorage.app", // If uploads fail, set to YOUR_PROJECT_ID.appspot.com
      messagingSenderId: "1089310382899",
      appId: "1:1089310382899:web:03b24e12f3a9e5c6d63c46"
    };

    let app, auth, db, storage;
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      db = firebase.firestore();
      storage = firebase.storage();
      db.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
    } catch (e) { console.error(e); }

    const $ = id => document.getElementById(id);
    const listEl = $('list');
    const emptyEl = $('empty');
    const sortModeEl = $('sortMode');
    const filterModeEl = $('filterMode');
    const statusEl = $('status');
 // Tabs + filter group
const tabListBtn = $('tabList');
const tabShoppingBtn = $('tabShopping');
const tabRecipesBtn = $('tabRecipes');
const filterGroup = $('filterGroup');

// Tab state
let activeTab = 'list';




    // Preferences
    const savedSort = localStorage.getItem('sortMode'); if (savedSort) sortModeEl.value = savedSort;
    const savedFilter = localStorage.getItem('filterMode'); if (savedFilter) filterModeEl.value = savedFilter;

    let user = null;
    let household = localStorage.getItem('household') || '';
    let unsubList = null;
    let lastSnapshotItems = [];
    let catalogCache = new Map();
    let lastAddedId = null;
let unsubRecipes = null;
let lastSnapshotRecipes = [];


    // New-item pending photo
    let newItemPhotoFile = null;
        // === Autocomplete / Update mode state ===
    let selectedItemId = null;
    let selectedItemInitialChecked = false;
    let selectedItemPhotoPath = null;

    const nameInput = $('itemName');
    const autoList = $('autoList');

    function escapeHtml(s){ 
      return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
    }

    function suggestionMeta(it){
      const parts = [];
      if (it.category) parts.push(it.category);
      if (it.size) parts.push(it.size);
      if (it.routeOrder !== '' && !isNaN(parseFloat(it.routeOrder))) parts.push('Route ' + it.routeOrder);
      return parts.join(' • ');
    }

    function showSuggestions(q){
      if (!autoList) return;
      q = (q||'').trim().toLowerCase();
      if (!q){ autoList.style.display='none'; autoList.innerHTML=''; return; }
      const matches = lastSnapshotItems
        .filter(it => (it.name||'').toLowerCase().includes(q))
        .sort((a,b)=>{
          const an=(a.name||'').toLowerCase(), bn=(b.name||'').toLowerCase();
          const as = an.startsWith(q) ? 0 : 1;
          const bs = bn.startsWith(q) ? 0 : 1;
          if (as !== bs) return as - bs;
          return an.localeCompare(bn);
        })
        .slice(0,8);
      if (!matches.length){ autoList.style.display='none'; autoList.innerHTML=''; return; }
      autoList.innerHTML = '';
      for (const it of matches){
        const row = document.createElement('div');
        row.className = 'ac-item';
        row.setAttribute('role','option');
        row.dataset.id = it.id;
        row.innerHTML = '<div class="ac-title">'+escapeHtml(it.name||'')+'</div>' +
                        '<div class="ac-meta">'+escapeHtml(suggestionMeta(it))+'</div>';
        autoList.appendChild(row);
      }
      autoList.style.display = 'block';
    }

    function clearUpdateMode(){
      selectedItemId = null;
      selectedItemInitialChecked = false;
      selectedItemPhotoPath = null;
      const tag = $('updateTag'); if (tag){ tag.style.display='none'; tag.innerHTML=''; }
      setPhotoPreview('');
    }

    function applySuggestion(item){
      selectedItemId = item.id;
      selectedItemInitialChecked = !!item.checked;
      selectedItemPhotoPath = item.photoPath || null;

      $('itemName').value = item.name || '';
      $('itemQty').value = item.qty || '';
      $('itemSize').value = item.size || '';
      $('itemNotes').value = item.notes || '';
      $('itemCategory').value = item.category || '';
      $('itemRoute').value = (item.routeOrder === '' || item.routeOrder === undefined || item.routeOrder === null) ? '' : item.routeOrder;

      setNewPhotoFile(null);
      setPhotoPreview(item.photoUrl || '');

      const tag = $('updateTag');
      if (tag){
        tag.innerHTML = 'Updating: <strong>'+escapeHtml(item.name||'')+'</strong> <button type="button" id="cancelUpdate" aria-label="Cancel">×</button>';
        tag.style.display = 'inline-flex';
        const cancel = $('cancelUpdate'); if (cancel) cancel.onclick = () => clearUpdateMode();
      }

      if (autoList){ autoList.style.display='none'; autoList.innerHTML=''; }
      const qtyField = $('itemQty'); if (qtyField) qtyField.focus();
    }

    // Wire events
    if (nameInput){
      nameInput.addEventListener('input', () => showSuggestions(nameInput.value));
      document.addEventListener('click', (e) => {
        if (!autoList) return;
        if (e.target === nameInput || (e.target.closest && e.target.closest('#autoList'))) return;
        autoList.style.display='none';
      });
    }
    if (autoList){
      autoList.addEventListener('mousedown', (e) => {
        const el = e.target.closest('.ac-item'); if (!el) return;
        const id = el.dataset.id;
        const item = lastSnapshotItems.find(x => x.id === id);
        if (item) applySuggestion(item);
        e.preventDefault();
      });
    }


    function setHouseholdUI() {
      $('household').value = household;
      $('householdView').textContent = household || '—';
    }
    setHouseholdUI();

    function setControlsEnabled(enabled){
      ['add','clearChecked','sortMode','filterMode','itemName','itemQty','itemCategory','itemRoute','itemSize','itemNotes','newItemAddPhoto']
        .forEach(id => { const n = $(id); if (!n) return; n.disabled = !enabled; n.classList.toggle('disabled', !enabled); });
    }

    function updateStatus(){
  // Clear safely
  statusEl.textContent = '';
  const add = (txt) => {
    const s = document.createElement('span');
    s.innerText = txt;
    if (statusEl.childNodes.length) statusEl.append(' • ');
    statusEl.append(s);
  };

  if (!auth || !db) add('SDK not loaded');
  add(auth && auth.currentUser ? 'Signed in' : 'Not signed in');
  add('household: ' + (household || '—'));

  const ready = !!auth && !!db && !!auth.currentUser && !!household;
  setControlsEnabled(ready);
}


   $('setHousehold').onclick = async () => {
  household = $('household').value.trim();
  localStorage.setItem('household', household);
  setHouseholdUI();
  await ensureHouseholdDoc();           // ← add this line
  subscribeList();
  updateStatus();
};


   $('signIn').onclick = async () => {
  try {
    const email = prompt("Enter email:");
    const password = prompt("Enter password:");
    if (!email || !password) return;

    await auth.signInWithEmailAndPassword(email, password);
    showToast("Signed in as " + email);
  } catch (e) {
    if (e.code === 'auth/user-not-found') {
      alert("No user found. Ask admin to add you in Firebase.");
    } else if (e.code === 'auth/wrong-password') {
      alert("Wrong password.");
    } else {
      alert("Sign-in failed: " + (e.message || e));
    }
  }
};


    $('signOut').onclick = async () => { await auth.signOut(); };

    auth && auth.onAuthStateChanged(u => {
      user = u;
      $('signIn').style.display = u ? 'none' : 'inline-block';
      $('signOut').style.display = u ? 'inline-block' : 'none';
      subscribeList(); 
  subscribeRecipes(); 
  warmCatalog(); 
  updateStatus();
    });
// === ensure parent /lists/{household} exists and is owned by current user ===
// Ensure /lists/{household} exists and add current user to members
async function ensureHouseholdDoc() {
  if (!auth || !auth.currentUser || !household) return;

  try {
    const uid = auth.currentUser.uid;

    // Data structure: members is a map of uid:true
    const data = {
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      members: {}
    };
    data.members[uid] = true;

    // Merge so it adds the user without overwriting existing members
    await db.collection('lists').doc(household).set(data, { merge: true });
  } catch (e) {
    console.error('ensureHouseholdDoc failed', e);
  }
}


   async function subscribeList(){
  if (unsubList) { unsubList(); unsubList = null; }
  if (!auth || !auth.currentUser || !household) { render([]); return; }
  await ensureHouseholdDoc();  // ← add this line
  unsubList = db.collection('lists').doc(household).collection('items').onSnapshot(snap => {
    const items = []; snap.forEach(d => items.push({ id: d.id, ...d.data() }));
    lastSnapshotItems = items;
    render(items);
  }, err => { console.error(err); alert('Cannot read list. Check Firestore rules and that Firestore is enabled.'); });
}
async function subscribeRecipes(){
  if (unsubRecipes) { unsubRecipes(); unsubRecipes = null; }
  if (!auth || !auth.currentUser || !household) { renderRecipes([]); return; }

  unsubRecipes = db.collection('recipes').doc(household).collection('recipes')
  .where('deletedAt','==', null)
  .onSnapshot(snap => {

      const arr = [];
snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
arr.sort((a,b) => (a.name||'').localeCompare(b.name||''));
lastSnapshotRecipes = arr;
renderRecipes(arr);

      
    }, err => {
      console.error(err);
      alert('Cannot read recipes. Check Firestore rules.');
    });
}


    function warmCatalog(){
      if (!auth || !auth.currentUser || !household) return;
      db.collection('catalog').doc(household).collection('items').get().then(qs => {
        catalogCache.clear();
        qs.forEach(doc => {
          const d = doc.data();
          catalogCache.set((d.name||'').toLowerCase(), { category: d.category||'', routeOrder: d.routeOrder ?? '' });
        });
      }).catch(()=>{});
    }


function render(items){
  // Start from all items
  let filtered = items;

  if (activeTab === 'shopping') {
    // Shopping tab: ONLY unchecked items
    filtered = items.filter(i => !i.checked);
  } else {
    // List tab: obey the dropdown filter
    const filterMode = filterModeEl.value;
    if (filterMode === 'unchecked') filtered = items.filter(i => !i.checked);
    else if (filterMode === 'checked') filtered = items.filter(i => !!i.checked);
    else if (filterMode === 'noroute') {
      filtered = items.filter(i =>
        i.routeOrder === undefined ||
        i.routeOrder === null ||
        i.routeOrder === '' ||
        isNaN(parseFloat(i.routeOrder))
      );
    }
  }

  // Render by chosen sort mode
  const mode = sortModeEl.value;
  if (mode === 'category') renderGroupedByCategory(filtered);
  else renderFlatByRoute(filtered);
}



    function renderFlatByRoute(items){
      const sorted = [...items].sort((a,b)=>{
        const ra = isNaN(parseFloat(a.routeOrder)) ? 1e9 : parseFloat(a.routeOrder);
        const rb = isNaN(parseFloat(b.routeOrder)) ? 1e9 : parseFloat(b.routeOrder);
        if (ra !== rb) return ra - rb;
        return (a.name||'').localeCompare(b.name||'');
      });

      listEl.innerHTML = '';
      if (!sorted.length){ emptyEl.style.display = 'block'; return; }
      emptyEl.style.display = 'none';
      for (const it of sorted) listEl.appendChild(renderRow(it));
    }

    function renderGroupedByCategory(items){
      const groups = new Map();
      for (const it of items){
        const key = (it.category || '').trim() || 'Uncategorized';
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      const catNames = [...groups.keys()].sort((a,b)=>a.localeCompare(b));
      listEl.innerHTML = '';
      if (!catNames.length){ emptyEl.style.display = 'block'; return; }
      emptyEl.style.display = 'none';

      for (const cat of catNames){
        const header = document.createElement('div');
        header.className = 'groupHeader';
        const dot = document.createElement('div'); dot.className='dot';
        const label = document.createElement('div'); label.textContent = cat;
        header.append(dot,label);
        listEl.appendChild(header);

        const box = document.createElement('div'); box.className = 'groupBox';
        const rows = groups.get(cat).sort((a,b)=>{
          const an = (a.name||''), bn = (b.name||'');
          const cmp = an.localeCompare(bn); if (cmp !== 0) return cmp;
          const ra = isNaN(parseFloat(a.routeOrder)) ? 1e9 : parseFloat(a.routeOrder);
          const rb = isNaN(parseFloat(b.routeOrder)) ? 1e9 : parseFloat(b.routeOrder);
          return ra - rb;
        });
        for (const it of rows) box.appendChild(renderRow(it));
        listEl.appendChild(box);
      }
    }
function renderRecipes(arr){
  const list = $('recipeList');
  const count = $('recipesCount');
  if (!list || !count) return;
  list.innerHTML = '';

  count.textContent = `${arr.length} recipe${arr.length===1?'':'s'}`;

  if (!arr.length){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'No recipes yet. Click "Add Recipe".';
    list.appendChild(empty);
    return;
  }

  for (const r of arr){
    const row = document.createElement('div');
    row.className = 'recipeRow';
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.gap = '8px';

   const left = document.createElement('div');
left.innerHTML = `<strong>${escapeHtml(r.name||'Untitled')}</strong> 
      <span class="muted">(${r.basePortions||1} portions)</span>`;

// optional: steps count hint
if (typeof r.stepCount === 'number') {
  const hint = document.createElement('span');
  hint.className = 'muted';
  hint.textContent = ` • ${r.stepCount} step${r.stepCount===1?'':'s'}`;
  left.appendChild(hint);
}

    if (r.tags && r.tags.length){
      const tags = document.createElement('span');
      tags.className = 'muted';
      tags.textContent = ' ' + r.tags.join(', ');
      left.appendChild(tags);
    }

    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '6px';

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => openRecipeModal('edit', r);

    const addBtn = document.createElement('button');
    addBtn.textContent = 'Add to List';
    addBtn.onclick = () => openAddToListModal(r);

    right.append(editBtn, addBtn);

    row.append(left, right);
    list.appendChild(row);
  }
}


    // ==== PHOTO: shared popup + global inputs ====
    const fileChooser = $('fileChooser');
    const fileCamera  = $('fileCamera');
    const popupEl = $('photoPopup');
    const btnTake = $('ppTake');
    const btnChoose = $('ppChoose');
    const btnCancel = $('ppCancel');

    // openPhotoPicker({ onFile: (File)=>void })
    function openPhotoPicker(ctx){
      if (!ctx || typeof ctx.onFile !== 'function') return;
      popupEl.classList.add('show');
      popupEl.setAttribute('aria-hidden','false');

      const cleanup = () => {
        popupEl.classList.remove('show');
        popupEl.setAttribute('aria-hidden','true');
        btnTake.onclick = btnChoose.onclick = btnCancel.onclick = null;
        document.removeEventListener('keydown', onEsc);
        fileChooser.onchange = null; fileCamera.onchange = null;
      };
      const onEsc = e => { if (e.key === 'Escape') cleanup(); };
      document.addEventListener('keydown', onEsc);
      popupEl.onclick = (e)=>{ if (e.target === popupEl) cleanup(); };

      const attachAndClick = (inputEl) => {
        inputEl.onchange = () => {
          const f = inputEl.files && inputEl.files[0];
          cleanup();
          if (f) ctx.onFile(f);
          inputEl.value = ''; // reset for next time
        };
        // On some browsers, must be inside a user gesture: use setTimeout 0
        setTimeout(()=> inputEl.click(), 0);
      };

      btnTake.onclick = () => attachAndClick(fileCamera);
      btnChoose.onclick = () => attachAndClick(fileChooser);
      btnCancel.onclick = cleanup;
    }

       function setNewPhotoFile(f){
      newItemPhotoFile = f || null;
      const photoName = $('photoName');
      if (photoName) photoName.textContent = f ? (f.name || '1 image selected') : '';
      if (f) setPhotoPreview(''); // hide existing preview if choosing a new file
    }
    function setPhotoPreview(url){
      const img = $('photoPreview'); if (!img) return;
      if (url){ img.src = url; img.style.display = 'block'; }
      else { img.removeAttribute('src'); img.style.display = 'none'; }
    }

  

    // Photo upload helpers for items
    async function uploadItemPhoto(file, itemId, prevPath){
      if (!auth || !auth.currentUser || !household) throw new Error('Sign in and set household first.');
      const clean = (file.name || 'photo').replace(/[^a-zA-Z0-9._-]/g,'_');
      const path = `${household}/${itemId}/${Date.now()}-${clean}`;
      const ref = storage.ref().child(path);
      const metadata = { contentType: file.type || 'image/jpeg', customMetadata: { uid: auth.currentUser.uid, itemId } };
      const snap = await ref.put(file, metadata);
      const url = await snap.ref.getDownloadURL();
      await db.collection('lists').doc(household).collection('items').doc(itemId).set({
        photoUrl: url, photoPath: path, photoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      if (prevPath && prevPath !== path) { try { await storage.ref().child(prevPath).delete(); } catch(e){} }
      return { url, path };
    }

    async function removeItemPhoto(itemId, photoPath){
      if (!auth || !auth.currentUser || !household) throw new Error('Sign in and set household first.');
      if (photoPath) { try { await storage.ref().child(photoPath).delete(); } catch(e){} }
      await db.collection('lists').doc(household).collection('items').doc(itemId).set({
        photoUrl: firebase.firestore.FieldValue.delete(),
        photoPath: firebase.firestore.FieldValue.delete(),
        photoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function renderRow(it){
      const row = document.createElement('div');
      row.className = 'item';
      row.dataset.cat = ((it.category || '').trim().toLowerCase().replace(/[^a-z0-9]+/g, '-'));

      /* 1) Checkbox */
      const left = document.createElement('div');
      left.className = 'left';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!it.checked;
 cb.onchange = async () => {
  const isChecked = !!cb.checked;
  const patch = {
    checked: isChecked,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // If the user checks the box, zero the qty
  if (isChecked) {
    patch.qty = '0';
  }

  try {
    await updateItem(it.id, patch);

    // reflect local state
    it.checked = isChecked;
    if (isChecked) {
      it.qty = '0';
      // Update the inline qty input on this row (if present)
      const qi = row.querySelector('.qty-inline');
      if (qi) qi.value = '0';
    }
  } catch (e) {
    console.error('Checkbox update failed:', e);
    showToast('Failed to update item');
  }
};




      left.appendChild(cb);

      /* 2) Title */
      const line1 = document.createElement('div');
      line1.className = 'line1';
      const catdot = document.createElement('span'); catdot.className = 'catdot';
      const nameEl = document.createElement('span');
nameEl.className = 'name';
nameEl.textContent = it.name || '';

// Show red flag if routeOrder is missing or invalid
const routeMissing = (
  it.routeOrder === undefined ||
  it.routeOrder === null ||
  it.routeOrder === '' ||
  isNaN(parseFloat(it.routeOrder))
);
if (routeMissing) {
  const flag = document.createElement('span');
  flag.textContent = ' 🚩';
  flag.title = 'No route number set';
  flag.style.color = 'red';
  nameEl.appendChild(flag);
}

line1.append(catdot, nameEl);
     // Inline editable qty + optional size text
const sep = document.createElement('span');
sep.className = 'sep';
sep.textContent = ' • ';

// Qty input
const qtyInline = document.createElement('input');
qtyInline.type = 'text';
qtyInline.inputMode = 'decimal';
qtyInline.placeholder = 'Qty';
qtyInline.className = 'qty-inline';
qtyInline.value = it.qty || '';

// When qty changes: save immediately. If item was checked AND old qty was 0/empty and new qty is positive/non-empty,
// auto-uncheck so it returns to the Shopping list.
qtyInline.addEventListener('change', async () => {
  const newQty = (qtyInline.value || '').trim();

  // helper: treat "", "0", "0.0", "0,0" as zero-ish
  const asNum = (s) => (typeof parseNum === 'function' ? parseNum(s) : NaN);
  const wasZeroish = !it.qty || asNum(it.qty) === 0;

  // positive/non-empty if: numeric > 0 OR non-numeric but non-empty string
  const n = asNum(newQty);
  const nowPositive = (Number.isFinite(n) && n > 0) || (!Number.isFinite(n) && newQty !== '');

  const shouldUncheck = !!it.checked && wasZeroish && nowPositive;

  try {
    const patch = {
      qty: newQty,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (shouldUncheck) patch.checked = false;

    await updateItem(it.id, patch);

    // reflect local state
    it.qty = newQty;
    if (shouldUncheck) {
      cb.checked = false;
      it.checked = false;
      showToast('Moved back to Shopping');
    }
  } catch (e) {
    console.error('Qty inline update failed:', e);
    showToast('Failed to update qty');
  }
});


// Optional size text after qty
sep.appendChild(qtyInline);
if (it.size) {
  const sizeSpan = document.createElement('span');
  sizeSpan.className = 'muted';
  sizeSpan.textContent = ' • ' + it.size;
  sep.appendChild(sizeSpan);
}

line1.append(sep);


      /* 3) Actions */
      const actions = document.createElement('div');
      actions.className = 'actions';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'editbtn';
      editBtn.textContent = 'Edit';
      editBtn.onclick = (ev) => {
        ev.stopPropagation();
        const editing = row.classList.toggle('editing');
        editBtn.textContent = editing ? 'Close' : 'Edit';
        if (editing) qty.focus();
      };

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'btn-icon';
      delBtn.title = 'Delete item';
      delBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use href="#i-trash"></use></svg>';
      delBtn.onclick = () => removeItem(it.id);

      actions.append(editBtn, delBtn);

      /* 4) Below row: media + notes */
      const below = document.createElement('div');
      below.className = 'below';

      const mediaCell = document.createElement('div');

      const mountCameraBtn = () => {
        mediaCell.innerHTML = '';
        const camBtn = document.createElement('button');
        camBtn.type = 'button';
        camBtn.className = 'camBtn';
        camBtn.title = 'Add photo';
        camBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use href="#i-camera"></use></svg>';
        camBtn.onclick = () => {
          openPhotoPicker({
            onFile: async (file) => {
              if (!file) return;
              try {
                showToast('Uploading photo…');
                const { url, path } = await uploadItemPhoto(file, it.id, it.photoPath || null);
                it.photoUrl = url; it.photoPath = path;
                mountThumb(url);
                below.classList.remove('hidden');
                showToast('Photo updated');
                removePhotoBtn.disabled = false;

              } catch(e){ alert('Upload failed: ' + (e.message || e)); }
            }
          });
        };
        mediaCell.appendChild(camBtn);
      };

      const mountThumb = (url) => {
        mediaCell.innerHTML = '';
        const thumb = document.createElement('img');
        thumb.className = 'thumb';
        thumb.src = url;
        thumb.alt = it.name || 'photo';
        thumb.onclick = () => openLightbox(url);
        mediaCell.appendChild(thumb);
      };

      if (it.photoUrl) mountThumb(it.photoUrl); else mountCameraBtn();

      const line2 = document.createElement('div');
      line2.className = 'line2';
      line2.textContent = it.notes || '';

      below.append(mediaCell, line2);

      if (!it.photoUrl && !it.notes) below.classList.add('hidden');

      /* 5) Editor row */
      const editor = document.createElement('div');
      editor.className = 'editor';

      const qty = document.createElement('input');
      qty.className = 'qty'; qty.placeholder = 'Qty'; qty.value = it.qty || '';
      qty.onchange = () => updateItem(it.id, { qty: qty.value });

      const size = document.createElement('input');
      size.className = 'size'; size.placeholder = 'Size'; size.value = it.size || '';
      size.onchange = () => updateItem(it.id, { size: size.value });

      const notes = document.createElement('input');
      notes.className = 'notes'; notes.placeholder = 'Notes'; notes.value = it.notes || '';
      notes.onchange = () => updateItem(it.id, { notes: notes.value });

      const cat  = document.createElement('select'); cat.className = 'category';
      ["", "Produce", "Meat & Poultry", "Fish & Seafood", "Dairy & Eggs", "Bakery", "Pantry", "Frozen", "Beverages", "Snacks & Confectionery", "Household & Cleaning", "Personal Care & Health", "Other"].forEach(opt => {
        const o = document.createElement('option'); o.value = opt; o.textContent = opt || '— Select —';
        if ((it.category||'') === opt) o.selected = true; cat.appendChild(o);
      });
      cat.onchange = () => updateItemAndCatalog(it, { category: cat.value });

      const route = document.createElement('input');
      route.className = 'route'; route.type = 'number'; route.step = '0.1'; route.placeholder = 'Route'; route.value = it.routeOrder ?? '';
      route.onchange = () => updateItemAndCatalog(it, { routeOrder: route.value ? Number(route.value) : '' });

      const changePhoto = document.createElement('button');
      changePhoto.type = 'button'; changePhoto.textContent = it.photoUrl ? 'Change photo' : 'Add photo';
      changePhoto.onclick = () => {
        openPhotoPicker({
          onFile: async (file) => {
            if (!file) return;
            try {
              showToast('Uploading photo…');
              const { url, path } = await uploadItemPhoto(file, it.id, it.photoPath || null);
              it.photoUrl = url; it.photoPath = path;
              mountThumb(url);
              below.classList.remove('hidden');
              showToast('Photo updated');
              removePhotoBtn.disabled = false;

            } catch(e){ alert('Upload failed: ' + (e.message || e)); }
          }
        });
      };

      const removePhotoBtn = document.createElement('button');
      removePhotoBtn.type = 'button'; removePhotoBtn.textContent = 'Remove photo';
      removePhotoBtn.disabled = !it.photoPath;
      removePhotoBtn.onclick = async () => {
        try {
          await removeItemPhoto(it.id, it.photoPath || null);
          it.photoUrl = ''; it.photoPath = '';
          mountCameraBtn();
          below.classList.toggle('hidden', !it.notes);
          showToast('Photo removed');
        } catch(e){
          alert('Failed to remove photo: ' + (e.message || e));
        }
      };

      editor.append(qty, size, notes, cat, route, changePhoto, removePhotoBtn);

      /* Assemble row */
      row.append(left, line1, actions, below, editor);

      // Flash if just added
      if (it.id === lastAddedId) {
        requestAnimationFrame(() => {
          row.classList.add('flash');
          row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          setTimeout(() => row.classList.remove('flash'), 900);
          lastAddedId = null;
        });
      }

      return row;
    }

    async function updateItem(id, patch){
      if (!auth || !auth.currentUser || !household) return alert('Sign in and set household first.');
      const ref = db.collection('lists').doc(household).collection('items').doc(id);
      await ref.set(patch, { merge: true });
    }

    async function updateItemAndCatalog(it, patch){
      await updateItem(it.id, patch);
      const name = (it.name||'').trim(); if (!name) return;
      const key = name.toLowerCase();
      const catRef = db.collection('catalog').doc(household).collection('items').doc(key);
      const data = { name, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      if (patch.category !== undefined) data.category = patch.category || '';
      if (patch.routeOrder !== undefined) data.routeOrder = (patch.routeOrder === '' ? '' : Number(patch.routeOrder));
      await catRef.set(data, { merge: true });
      catalogCache.set(key, { category: data.category ?? '', routeOrder: data.routeOrder ?? '' });
    }

    async function removeItem(id){
      if (!auth || !auth.currentUser || !household) return;
      // best-effort: delete attached photo too
      try{
        const doc = await db.collection('lists').doc(household).collection('items').doc(id).get();
        const d = doc.exists ? doc.data() : null;
        if (d && d.photoPath) { try { await storage.ref().child(d.photoPath).delete(); } catch(e){} }
      }catch(e){}
      await db.collection('lists').doc(household).collection('items').doc(id).delete();
    }

  $('clearChecked').onclick = async () => {
  if (!auth || !auth.currentUser || !household) return alert('Sign in and set household first.');

  // Uncheck all checked items; do NOT delete docs or photos.
  const qs = await db.collection('lists').doc(household).collection('items')
    .where('checked','==',true).get();

  if (qs.empty) { showToast('Nothing to clear'); return; }

  const batch = db.batch();
  qs.forEach(doc => {
    batch.set(doc.ref, { checked: false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
  });

  await batch.commit();
  showToast('Unchecked all items');
};


    // === Add new item ===
    $('newItemAddPhoto').onclick = () => {
      openPhotoPicker({
        onFile: (file) => {
          setNewPhotoFile(file);
          showToast('Photo selected');
        }
      });
    };

        $('add').onclick = async () => {
      if (!auth || !auth.currentUser || !household) return alert('Click Sign in, then set the household code.');
      const name = $('itemName').value.trim(); if (!name) return alert('Type an item name.');
      const qty = $('itemQty').value.trim();
      const size = $('itemSize').value.trim();
      let category = $('itemCategory').value.trim ? $('itemCategory').value.trim() : $('itemCategory').value;
      let routeOrder = $('itemRoute').value ? Number($('itemRoute').value) : '';
      const notes = $('itemNotes').value.trim();
      const photoFile = newItemPhotoFile || null;

      const known = catalogCache.get(name.toLowerCase());
      if (known){
        if (!category && known.category) category = known.category;
        if ((routeOrder === '' || isNaN(routeOrder)) && (known.routeOrder || known.routeOrder===0)) routeOrder = known.routeOrder;
      }

      // === UPDATE existing item if a suggestion was selected ===
      if (selectedItemId){
        try{
          await updateItem(selectedItemId, {
            name,
            qty,
            size,
            notes,
            category: category || '',
            routeOrder: routeOrder === '' ? '' : Number(routeOrder),
            checked: false, // force unchecked so it shows on the active list
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          if (photoFile){
            try {
              await uploadItemPhoto(photoFile, selectedItemId, selectedItemPhotoPath || null);
            } catch(e){ console.warn('Photo upload during update failed:', e.message); }
          }

          // Update catalog (same as create path)
          try{
            await db.collection('catalog').doc(household).collection('items')
              .doc(name.toLowerCase())
              .set({
                name,
                category: category || '',
                routeOrder: routeOrder === '' ? '' : Number(routeOrder),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }, { merge: true });
            catalogCache.set(name.toLowerCase(), {
              category: category || '',
              routeOrder: routeOrder === '' ? '' : Number(routeOrder)
            });
          } catch(e){ console.warn('Catalog save failed:', e.message); }

          showToast(selectedItemInitialChecked ? `Unchecked and updated '${name}'.` : `Updated '${name}'.`);
        } catch(e){
          alert('Failed to update: ' + (e.message || e));
          return;
        }

        // Clear form + state
        $('itemName').value=''; $('itemQty').value=''; $('itemSize').value='';
        $('itemCategory').value=''; $('itemRoute').value=''; $('itemNotes').value='';
        $('itemName').focus();
        newItemPhotoFile = null;
        const pn = $('photoName'); if (pn) pn.textContent = '';
        setPhotoPreview('');
        clearUpdateMode();
        return;
      }

      // === CREATE new item (existing behavior) ===
      let newId = null;
      try {
        const ref = db.collection('lists').doc(household).collection('items').doc();
        newId = ref.id;
        await ref.set({
          name, qty, size, notes,
          category: category || '',
          routeOrder: routeOrder === '' ? '' : Number(routeOrder),
          checked: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        lastAddedId = newId;
      } catch(e){
        return alert('Add failed: ' + (e.message || e));
      }

      if (photoFile && newId){
        try{
          await uploadItemPhoto(photoFile, newId, null);
        } catch(e){ console.warn('Photo upload failed:', e.message); }
      }

      // Save to catalog for next time
      if (name){
        try{
          await db.collection('catalog').doc(household).collection('items')
            .doc(name.toLowerCase())
            .set({
              name,
              category: category || '',
              routeOrder: routeOrder === '' ? '' : Number(routeOrder),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          catalogCache.set(name.toLowerCase(), {
            category: category || '',
            routeOrder: routeOrder === '' ? '' : Number(routeOrder)
          });
        } catch(e){ console.warn('Catalog save failed:', e.message); }
      }

      // clear form (existing)
      $('itemName').value=''; $('itemQty').value=''; $('itemSize').value='';
      $('itemCategory').value=''; $('itemRoute').value=''; $('itemNotes').value='';
      $('itemName').focus();

      // clear pending new photo
      newItemPhotoFile = null;
      const pn = $('photoName'); if (pn) pn.textContent = '';
      setPhotoPreview('');
    };

    

    sortModeEl.onchange = () => { localStorage.setItem('sortMode', sortModeEl.value); render(lastSnapshotItems); };
    filterModeEl.onchange = () => { localStorage.setItem('filterMode', filterModeEl.value); render(lastSnapshotItems); };
function setActiveTab(tab){ // 'list' | 'shopping' | 'recipes'
  activeTab = tab;
  const isShopping = tab === 'shopping';
  const isRecipes  = tab === 'recipes';

  // Toggle tab highlight
  if (tabListBtn)     tabListBtn.classList.toggle('active', tab === 'list');
  if (tabShoppingBtn) tabShoppingBtn.classList.toggle('active', isShopping);
  if (tabRecipesBtn)  tabRecipesBtn.classList.toggle('active', isRecipes);

  // Sections
  const listSection = $('listSection');
  const recipesView = $('recipesView');
 // Show the shopping list on both List and Shopping tabs; hide only on Recipes
if (listSection) listSection.style.display = isRecipes ? 'none' : '';
if (recipesView) recipesView.style.display = isRecipes ? '' : 'none';


  // Show list-only controls on List tab; hide elsewhere
  const addRow   = $('addRow');
  const clearBtn = $('clearChecked');
  if (addRow)   addRow.style.display   = (tab === 'list') ? '' : 'none';
  if (clearBtn) clearBtn.style.display = (tab === 'list') ? '' : 'none';

  // Hide Filter group outside List
  if (filterGroup) filterGroup.style.display = (tab === 'list') ? '' : 'none';

  // "How it works" only on List; auth controls visible except Shopping
  const how = $('howItWorks');
  if (how) how.style.display = (tab === 'list') ? '' : 'none';

  const authControls = $('authControls');
  if (authControls) authControls.style.display = isShopping ? 'none' : '';

  localStorage.setItem('activeTab', tab);

    // Always re-render so filtering matches the active tab
  render(lastSnapshotItems || []);
}


// Wire tab buttons
if (tabListBtn) tabListBtn.onclick = () => setActiveTab('list');
if (tabShoppingBtn) tabShoppingBtn.onclick = () => setActiveTab('shopping');
if (tabRecipesBtn) tabRecipesBtn.onclick = () => setActiveTab('recipes');


// Restore last tab (default to 'list')
setActiveTab(localStorage.getItem('activeTab') || 'list');
    // ==== Recipe ingredient helpers ====
function nameKey(s){ return (s||'').trim().toLowerCase(); }

// Build one ingredient row object from current DOM row
function readIngRow(row){
  return {
    name: (row.querySelector('.ing-name')?.value || '').trim(),
    nameKey: nameKey(row.querySelector('.ing-name')?.value || ''),
    qty: (row.querySelector('.ing-qty')?.value || '').trim(),
    size: (row.querySelector('.ing-size')?.value || '').trim(),
   
    
    notes: (row.querySelector('.ing-notes')?.value || '').trim()
  };
}

// Gather all ingredient rows from the modal
function readAllIngredients(){
  const rows = Array.from(document.querySelectorAll('#rmIngList .ing-row'));
  const list = rows.map(readIngRow).filter(x => x.name); // keep only rows with a name
  return list;
}

// Create an ingredient row DOM (with autocomplete for name)
function createIngRow(prefill=null){
  const row = document.createElement('div');
  row.className = 'ing-row';
  row.style.display = 'grid';
  row.style.gridTemplateColumns = '1.2fr 0.7fr 0.8fr 1fr 100px 1fr auto';
  row.style.gap = '8px';
  row.style.alignItems = 'center';

  row.innerHTML = `
    <input class="ing-name"  placeholder="Name" />
    <input class="ing-qty"   placeholder="Qty (recipe)" />
    <input class="ing-size"  placeholder="Size (kept as text)" />
  <input class="ing-notes" placeholder="Notes" />
<span class="ing-updateTag muted" style="display:none;"></span>
<button class="ing-del" type="button" title="Remove">✕</button>
`;
// Ensure no update tag initially
const tagEl = row.querySelector('.ing-updateTag');
if (tagEl){ tagEl.style.display='none'; tagEl.innerHTML=''; }



  // Prefill if provided
  if (prefill){
    row.querySelector('.ing-name').value  = prefill.name || '';
    row.querySelector('.ing-qty').value   = prefill.qty || '';
    row.querySelector('.ing-size').value  = prefill.size || '';
   
    row.querySelector('.ing-notes').value = prefill.notes || '';
  }

  // Delete row
  row.querySelector('.ing-del').onclick = () => row.remove();

  // ENTER on the last field adds a new row
  row.querySelector('.ing-notes').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.isComposing){
      e.preventDefault();
      addIngredientRow(); // defined below
    }
  });

  // === Inline autocomplete for name (reusing your catalog + lastSnapshotItems) ===
  const nameInput = row.querySelector('.ing-name');
  const ac = document.createElement('div');
  ac.className = 'ac-list';
  ac.style.position = 'absolute';
  ac.style.display = 'none';
  ac.style.zIndex = '70';
  ac.style.maxHeight = '240px';
  ac.style.overflow = 'auto';
  ac.style.left = '0'; ac.style.right = '0';
  // wrap name input to position ac-list
  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  nameInput.replaceWith(wrap);
  wrap.appendChild(nameInput);
  wrap.appendChild(ac);

  function buildSuggestionMeta(it){
    const parts = [];
    if (it.category) parts.push(it.category);
    if (it.size) parts.push(it.size);
    if (it.routeOrder !== '' && !isNaN(parseFloat(it.routeOrder))) parts.push('Route ' + it.routeOrder);
    return parts.join(' • ');
  }

  function openAC(q){
    q = (q||'').trim().toLowerCase();
    if (!q){ ac.style.display='none'; ac.innerHTML=''; return; }

    // source: lastSnapshotItems (live list) + catalogCache
    const pool = [];

// Live list items (often have richer data incl. notes)
lastSnapshotItems.forEach(d => pool.push({
  name: d.name || '',
  category: d.category || '',
  size: d.size || '',
  routeOrder: (d.routeOrder ?? ''),
  notes: d.notes || ''
}));

// Catalog fallback (category/route remembered; no notes/size usually)
catalogCache.forEach((v, k) => {
  pool.push({
    name: k, // k is lowercased, but fine for prefilling
    category: v.category || '',
    size: '',
    routeOrder: (v.routeOrder ?? ''),
    notes: ''
  });
});


    const seen = new Set();
    const matches = pool.filter(it => {
      const n = (it.name||'').toLowerCase();
      if (seen.has(n)) return false;
      if (n.includes(q)){ seen.add(n); return true; }
      return false;
    }).sort((a,b)=>{
      const an=(a.name||'').toLowerCase(), bn=(b.name||'').toLowerCase();
      const as = an.startsWith(q) ? 0 : 1;
      const bs = bn.startsWith(q) ? 0 : 1;
      if (as !== bs) return as - bs;
      return an.localeCompare(bn);
    }).slice(0,8);

    if (!matches.length){ ac.style.display='none'; ac.innerHTML=''; return; }

 ac.innerHTML = '';
matches.forEach(it => {
  const opt = document.createElement('div');
  opt.className = 'ac-item';
  opt.innerHTML =
    '<div class="ac-title">' + escapeHtml(it.name) + '</div>' +
    '<div class="ac-meta">' + escapeHtml(buildSuggestionMeta(it)) + '</div>';

  // When a suggestion is picked
  opt.onmousedown = (e) => {
    e.preventDefault();
    nameInput.value = it.name;

    const hostRow = wrap.closest('.ing-row') || opt;

    // Prefill size/notes only if empty
    const sizeEl  = hostRow.querySelector('.ing-size');
    if (sizeEl && it.size && !sizeEl.value) sizeEl.value = it.size;

    const notesEl = hostRow.querySelector('.ing-notes');
    if (notesEl && it.notes && !notesEl.value) notesEl.value = it.notes;

    // “Updating: … ×” tag (no backticks)
    const tag = hostRow.querySelector('.ing-updateTag');
    if (tag) {
      tag.innerHTML = 'Updating: <strong>' + escapeHtml(it.name) + '</strong> <button type="button" class="cancelUpdate">×</button>';
      tag.style.display = 'inline';
      const cancelBtn = tag.querySelector('.cancelUpdate');
      cancelBtn.onclick = () => {
        tag.style.display = 'none';
        tag.innerHTML = '';
        nameInput.value = '';
        nameInput.focus();
      };
    }

    ac.style.display = 'none';
  };

  ac.appendChild(opt);
});
ac.style.display = 'block';

  }

  nameInput.addEventListener('input', ()=>openAC(nameInput.value));
  document.addEventListener('click', (e)=>{
    if (!ac.contains(e.target) && e.target !== nameInput) ac.style.display='none';
  });

  return row;
}

function addIngredientRow(prefill=null){
  const host = $('rmIngList'); if (!host) return;
  const r = createIngRow(prefill);
  host.appendChild(r);
  r.querySelector('.ing-name').focus();
}

// Load ingredients into modal when editing
async function loadRecipeIngredients(recipeId){
  try{
    const snap = await db.collection('recipes').doc(household)
      .collection('recipes').doc(recipeId).collection('ingredients').get();
    $('rmIngList').innerHTML = '';
    if (snap.empty){ addIngredientRow(); return; }
    snap.forEach(doc => addIngredientRow(doc.data()));
  } catch(e){
    console.warn('Failed to load ingredients:', e.message || e);
    $('rmIngList').innerHTML = '';
    addIngredientRow();
  }
}
    // ===== Recipe Steps helpers =====

// Create one step row
function createStepRow(prefill=null){
  const row = document.createElement('div');
  row.className = 'step-row';

  row.innerHTML = `
    <div class="step-num">1</div>
    <textarea class="step-text" placeholder="Describe this step…"></textarea>
    <div style="display:flex; gap:6px;">
      <button class="step-up"   type="button" title="Move up">↑</button>
      <button class="step-down" type="button" title="Move down">↓</button>
      <button class="step-del"  type="button" title="Remove">✕</button>
    </div>
  `;

  // Prefill
  if (prefill && prefill.text) {
    row.querySelector('.step-text').value = prefill.text;
  }

  // Handlers
  const up   = row.querySelector('.step-up');
  const down = row.querySelector('.step-down');
  const del  = row.querySelector('.step-del');

  up.onclick = () => {
    const host = $('rmSteps'); if (!host) return;
    const prev = row.previousElementSibling;
    if (prev && prev.classList.contains('step-row')) {
      host.insertBefore(row, prev);
      renumberStepRows();
    }
  };
  down.onclick = () => {
    const host = $('rmSteps'); if (!host) return;
    const next = row.nextElementSibling;
    if (next && next.classList.contains('step-row')) {
      host.insertBefore(next, row);
      renumberStepRows();
    }
  };
  del.onclick = () => {
    row.remove();
    renumberStepRows();
  };

  // Renumber on input (so empty/filled doesn’t matter; purely cosmetic while editing)
  row.querySelector('.step-text').addEventListener('input', () => {
    // no-op for now; kept for future validation hooks
  });

  return row;
}

function addStepRow(prefill=null){
  const host = $('rmSteps'); if (!host) return;
  const r = createStepRow(prefill);
  host.appendChild(r);
  renumberStepRows();
  const ta = r.querySelector('.step-text'); if (ta) ta.focus();
}

function renumberStepRows(){
  const rows = Array.from(document.querySelectorAll('#rmSteps .step-row'));
  rows.forEach((r, i) => {
    const badge = r.querySelector('.step-num'); if (badge) badge.textContent = (i+1);
  });
}
    // Basic drag & drop for step rows (pointer events)
function enableStepDragDrop(){
  const host = $('rmSteps'); if (!host) return;

  let dragging = null;
  let placeholder = null;
  let startY = 0;

  function onPointerMove(e){
    if (!dragging) return;
    e.preventDefault();
    const y = e.clientY;
    const dy = y - startY;
    dragging.style.transform = `translateY(${dy}px)`;

    // Find the step-row we're hovering over to place placeholder
    const rows = Array.from(host.querySelectorAll('.step-row')).filter(r => r !== dragging);
    const midY = dragging.getBoundingClientRect().top + dragging.offsetHeight/2 + dy;

    let insertBefore = null;
    for (const r of rows){
      const rect = r.getBoundingClientRect();
      if (midY < rect.top + rect.height/2){ insertBefore = r; break; }
    }
    if (insertBefore) host.insertBefore(placeholder, insertBefore);
    else host.appendChild(placeholder);
  }

  function onPointerUp(){
    if (!dragging) return;
    dragging.style.transform = '';
    dragging.classList.remove('is-pressed');
    // Insert dragged row at placeholder
    host.insertBefore(dragging, placeholder);
    placeholder.remove(); placeholder = null;

    document.removeEventListener('pointermove', onPointerMove);
    document.removeEventListener('pointerup', onPointerUp);
    dragging.releasePointerCapture && dragging.releasePointerCapture(dragging._pointerId);
    dragging = null;
    renumberStepRows();
  }

  host.addEventListener('pointerdown', (e) => {
    const row = e.target.closest('.step-row'); if (!row) return;
    // Allow grabbing via number badge or left area
    if (!e.target.closest('.step-num') && !e.target.closest('.step-text')) return;
    // if text area drag is annoying, change the line above to only .step-num

    dragging = row;
    dragging._pointerId = e.pointerId;
    dragging.setPointerCapture && dragging.setPointerCapture(e.pointerId);
    startY = e.clientY;

    // Placeholder
    placeholder = document.createElement('div');
    placeholder.style.height = `${row.offsetHeight}px`;
    placeholder.style.border = '1px dashed #e5e7eb';
    placeholder.style.borderRadius = '10px';
    host.insertBefore(placeholder, row.nextElementSibling);

    dragging.classList.add('is-pressed');
    document.addEventListener('pointermove', onPointerMove);
    document.addEventListener('pointerup', onPointerUp);
  });
}


function readAllSteps(){
  const rows = Array.from(document.querySelectorAll('#rmSteps .step-row'));
  const list = [];
  rows.forEach((r, i) => {
    const text = (r.querySelector('.step-text')?.value || '').trim();
    if (text) list.push({ order: i, text, done: false });
  });
  return list;
}

// Load steps (edit mode) ordered by 'order'
async function loadRecipeSteps(recipeId){
  try{
    const host = $('rmSteps'); if (!host) return;
    host.innerHTML = '';
    const qs = await db.collection('recipes').doc(household)
      .collection('recipes').doc(recipeId).collection('steps')
      .orderBy('order', 'asc').get();

    if (qs.empty){
      addStepRow(); // start with one blank
      return;
    }
    qs.forEach(d => {
      const x = d.data() || {};
      addStepRow({ text: x.text || '' });
    });
    renumberStepRows();
  } catch(e){
    console.warn('Failed to load steps:', e.message || e);
    const host = $('rmSteps'); if (host){ host.innerHTML=''; addStepRow(); }
  }
}
// === Hard-delete a recipe (danger!) ===
// Removes cover file, subcollections (ingredients, steps), then the recipe doc.
// Exposed as window.hardDeleteRecipe(recipeId) and also via Alt+Click on Delete.
async function hardDeleteRecipe(recipeId){
  if (!auth || !auth.currentUser || !household || !recipeId) throw new Error('Not ready');

  // Load recipe meta first (for coverPath)
  const ref = db.collection('recipes').doc(household).collection('recipes').doc(recipeId);
  const snap = await ref.get();
  if (!snap.exists) return;

  const data = snap.data() || {};
  const who = (auth.currentUser.email || auth.currentUser.uid || 'unknown');
  console.log('[HardDelete] Starting for', recipeId);

  // 1) Delete cover file if any
  if (data.coverPath) {
    try { await storage.ref().child(data.coverPath).delete(); } catch(e){ console.warn('cover delete failed:', e.message||e); }
  }

  // 2) Delete subcollections
  const ingCol = ref.collection('ingredients');
  const stepCol = ref.collection('steps');

  // Helper to batch-delete a small collection
  async function deleteAll(colRef){
    const qs = await colRef.get();
    if (qs.empty) return;
    const batch = db.batch();
    qs.forEach(d => batch.delete(d.ref));
    await batch.commit();
  }

  await deleteAll(ingCol);
  await deleteAll(stepCol);

  // 3) Finally delete the recipe doc
  await ref.delete();

  showToast('Recipe hard-deleted');
  console.log('[HardDelete] Done for', recipeId, 'by', who);
}

// Expose for console use
window.hardDeleteRecipe = hardDeleteRecipe;


// ==== Recipes: modal wiring (shell only) ====
    let editingRecipeId = null; // null = add mode, otherwise recipeId

// Toggle tags on/off inside the modal
const rmTagsEl = $('rmTags');
if (rmTagsEl) {
  rmTagsEl.addEventListener('click', (e) => {
    const chip = e.target.closest('.tagchip');
    if (!chip) return;
    chip.classList.toggle('active');
  });
}
function getActiveTags(){
  const chips = document.querySelectorAll('#rmTags .tagchip.active');
  return Array.from(chips).map(el => el.dataset.tag).filter(Boolean);
}
function clearActiveTags(){
  document.querySelectorAll('#rmTags .tagchip.active').forEach(el => el.classList.remove('active'));
}

const recipesView = $('recipesView');
const btnOpenAddRecipe = $('btnOpenAddRecipe');

const recipeModal = $('recipeModal');
const rmClose = $('rmClose');
const rmSave = $('rmSave');
const rmDelete = $('rmDelete');
    // Add-ingredient button (wire once at top-level)
const rmAddIngBtn = $('rmAddIng');
if (rmAddIngBtn) rmAddIngBtn.onclick = () => addIngredientRow();
    // Add-step button
const rmAddStepBtn = $('rmAddStep');
if (rmAddStepBtn) rmAddStepBtn.onclick = () => addStepRow();



function openRecipeModal(mode='add', data=null){
  $('rmTitle').textContent = mode === 'edit' ? 'Edit Recipe' : 'Add Recipe';
  editingRecipeId = (mode === 'edit' && data && data.id) ? data.id : null;
  // Show Delete only in edit mode
if (rmDelete) {
  rmDelete.style.display = editingRecipeId ? '' : 'none';
}


  // reset fields
  $('rmName').value = (data && data.name) || '';
  $('rmBasePortions').value = (data && data.basePortions) || 2;

  // tags
  clearActiveTags();
  const preset = (data && Array.isArray(data.tags)) ? data.tags : [];
  preset.forEach(t => {
    const chip = document.querySelector(`#rmTags .tagchip[data-tag="${t}"]`);
    if (chip) chip.classList.add('active');
  });

  // cover preview (actual upload wired later)
  const p = $('rmCoverPreview'); 
  if (p){
    if (data && data.coverUrl){
      p.src = data.coverUrl; p.style.display='block';
      $('rmCoverRemove').style.display = '';
      $('rmCoverName').textContent = '';
    } else {
      p.src=''; p.style.display='none';
      $('rmCoverRemove').style.display = 'none';
      $('rmCoverName').textContent = '';
    }
  }

  // clear lists (ingredients/steps wired later)
  // Ingredients
$('rmIngList').innerHTML = '';
if (editingRecipeId) {
  // load existing ingredients for edit
  loadRecipeIngredients(editingRecipeId);
} else {
  addIngredientRow(); // start with one empty row
}
// Steps
$('rmSteps').innerHTML = '';
if (editingRecipeId) {
  // load existing steps for edit
  loadRecipeSteps(editingRecipeId);
  enableStepDragDrop();

} else {
  addStepRow(); // start with one empty row
  enableStepDragDrop();

}



  // show modal
  recipeModal.classList.add('show');
  recipeModal.setAttribute('aria-hidden','false');
  $('rmName').focus();

}
function closeRecipeModal(){
  recipeModal.classList.remove('show');
  recipeModal.setAttribute('aria-hidden','true');
}

if (btnOpenAddRecipe) btnOpenAddRecipe.onclick = () => openRecipeModal('add');
if (rmClose) rmClose.onclick = closeRecipeModal;
   // Delete button: soft delete by default; ALT+Click => hard delete
if (rmDelete) rmDelete.onclick = async (ev) => {
  if (!auth || !auth.currentUser || !household || !editingRecipeId) return;

  const hard = !!ev.altKey; // hold Alt for hard delete
  if (!hard) {
    const ok = confirm('Delete this recipe? It will be hidden from the list (soft delete).');
    if (!ok) return;

    try {
      const ref = db.collection('recipes').doc(household)
        .collection('recipes').doc(editingRecipeId);

      await ref.set({
        deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: (auth.currentUser.email || auth.currentUser.uid || 'unknown')
      }, { merge: true });

      showToast('Recipe deleted');
      closeRecipeModal();
    } catch (e) {
      console.error(e);
      alert('Delete failed: ' + (e.message || e));
    }
  } else {
    const ok = confirm('HARD DELETE? This will permanently remove the recipe, its steps and ingredients, and the cover file. This cannot be undone.');
    if (!ok) return;
    try {
      await hardDeleteRecipe(editingRecipeId);
      closeRecipeModal();
    } catch (e) {
      console.error(e);
      alert('Hard delete failed: ' + (e.message || e));
    }
  }
};


if (rmSave) rmSave.onclick = async () => {
  if (!auth || !auth.currentUser || !household) { alert('Sign in and set the household first.'); return; }
  


  const name = ($('rmName').value || '').trim();
  const basePortions = Math.max(1, parseInt(($('rmBasePortions').value || '1'), 10));
  const tags = getActiveTags();
  if (!name) { alert('Please enter a recipe name.'); $('rmName').focus(); return; }

  const nameLower = name.toLowerCase();

  try {
    const col = db.collection('recipes').doc(household).collection('recipes');

    // Duplicate-name guard (ignore the same doc if editing)
    const qs = await col.where('nameLower','==', nameLower).get();
    const dup = qs.docs.find(d => {
      const data = d.data() || {};
      const isDeleted = !!data.deletedAt;
      const isSame = editingRecipeId && d.id === editingRecipeId;
      return !isDeleted && !isSame;
    });
    if (dup) {
      alert('A recipe with that name already exists.');
      return;
    }

    const now = firebase.firestore.FieldValue.serverTimestamp();
    const who = (auth.currentUser.email || auth.currentUser.uid || 'unknown');

    if (!editingRecipeId) {
      // ADD
      const ref = col.doc();
      await ref.set({
        name,
        nameLower,
        basePortions,
        tags,
        coverUrl: null,
        coverPath: null,
        lastUsedServings: basePortions,
        createdAt: now,
        createdBy: who,
        updatedAt: now,
        updatedBy: who,
        deletedAt: null
      });
      showToast('Recipe created');
        } else {
      // UPDATE meta
      const ref = col.doc(editingRecipeId);
      await ref.set({
        name,
        nameLower,
        basePortions,
        tags,
        updatedAt: now,
        updatedBy: who
      }, { merge: true });
      showToast('Recipe updated');
    }

    // === Save ingredients (replace-all strategy) ===
    const recipeId = editingRecipeId ? editingRecipeId : (await db.collection('recipes').doc(household).collection('recipes').where('nameLower','==', nameLower).limit(1).get()).docs[0].id;

    const ingCol = db.collection('recipes').doc(household).collection('recipes').doc(recipeId).collection('ingredients');
    // delete existing
    const existing = await ingCol.get();
    const batch = db.batch();
    existing.forEach(doc => batch.delete(doc.ref));

    // add current rows
    const ings = readAllIngredients();
    ings.forEach(it => {
      const ref = ingCol.doc();
      batch.set(ref, {
        name: it.name,
        nameKey: it.nameKey,
        qty: it.qty,           // scaling happens later, not here
        size: it.size,         // never scaled (your requirement)
        
        
        notes: it.notes
      });
    });

      await batch.commit();

    // === Save steps (replace-all strategy) ===
    try{
      const stepsCol = db.collection('recipes').doc(household)
        .collection('recipes').doc(recipeId).collection('steps');

      // delete existing
      const existingSteps = await stepsCol.get();
      const sBatch = db.batch();
      existingSteps.forEach(doc => sBatch.delete(doc.ref));

      // add current rows
      const steps = readAllSteps(); // [{order, text, done:false}, ...]
      steps.forEach(s => {
        const ref = stepsCol.doc();
        sBatch.set(ref, {
          order: Number(s.order) || 0,
          text: s.text || '',
          done: !!s.done
        });
      });

      await sBatch.commit();
      // also update stepCount in recipe meta
const stepCount = (steps && steps.length) ? steps.length : 0;
await db.collection('recipes').doc(household)
  .collection('recipes').doc(recipeId)
  .set({ stepCount }, { merge: true });

    } catch(e){
      console.warn('Failed to save steps:', e.message || e);
      // We don’t abort the whole save; ingredients/meta are already saved.
    }

    closeRecipeModal();


  } catch (e) {
    console.error(e);
    alert('Save failed: ' + (e.message || e));
  }
};



// ==== Add-to-List modal wiring (full) ====
const addToListModal = $('addToListModal');
const atlClose       = $('atlClose');
const atlListEl      = $('atlList');
const atlServingsEl  = $('atlServings');
const atlInc         = $('atlInc');
const atlDec         = $('atlDec');
const atlPresets     = document.querySelectorAll('.preset-row .preset');
const atlSelectAll   = $('atlSelectAll');
const atlAddBtn      = $('atlAdd');

let atlRecipe = null;          // recipe meta being added
let atlBasePortions = 2;       // base portions (from recipe)
let atlIngredients = [];       // [{name, nameKey, qty, size, notes}, ...]
let atlServings = 2;           // current servings in the modal

// --- Qty helpers (numbers only; keep text if not a number)
function parseNum(s){
  const n = parseFloat((s||'').toString().trim().replace(',', '.'));
  return Number.isFinite(n) ? n : null;
}
function fmtNum(n){
  // 2 decimals max, strip trailing zeros
  const s = (Math.round(n*100)/100).toString();
  return /.\d$/.test(s) ? s : Number(s).toString();
}
function scaleQtyStr(qtyStr, factor){
  const n = parseNum(qtyStr);
  if (n === null) return qtyStr || '';
  return fmtNum(n * factor);
}
function addQtyStr(aStr, bStr){
  const a = parseNum(aStr), b = parseNum(bStr);
  if (a === null || b === null){
    // fallback: prefer non-empty, otherwise concatenate
    if (!aStr) return bStr;
    if (!bStr) return aStr;
    return aStr + ' + ' + bStr;
  }
  return fmtNum(a + b);
}

// Find existing list item (case-insensitive name match)
function findExistingItem(nameKey){
  const key = (nameKey||'').trim().toLowerCase();
  return lastSnapshotItems.find(it => (it.name||'').trim().toLowerCase() === key) || null;
}

// Build the checklist rows for current servings
function renderAtlList(){
  if (!atlListEl) return;
  atlListEl.innerHTML = '';

  const factor = Math.max(1, atlServings) / Math.max(1, atlBasePortions);

  for (const ing of atlIngredients){
    const scaledQty = scaleQtyStr(ing.qty || '', factor);
    const existing  = findExistingItem(ing.nameKey || ing.name);
    const haveTxt   = existing && (existing.qty || existing.size) 
      ? (existing.qty || '') 
      : '';

    const row = document.createElement('div');
    row.className = 'checkrow';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = true;

    const label = document.createElement('div');
    const main = document.createElement('div');
    main.innerHTML = '<strong>'+escapeHtml(ing.name)+'</strong>' +
      (ing.size ? ' <span class="muted">• '+escapeHtml(ing.size)+'</span>' : '');
    const sub  = document.createElement('div');
    sub.className = 'muted';
    sub.textContent = 'Qty: ' + (scaledQty || '—');
    if (haveTxt){
      const hint = document.createElement('span');
      hint.className = 'muted';
      hint.textContent = '  (have ' + haveTxt + ' already)';
      sub.appendChild(hint);
    }
    label.append(main, sub);

    row.append(cb, label, document.createElement('div'));
    // store refs on DOM for readback
    row._ing = ing;
    row._cb  = cb;
    row._scaledQty = scaledQty;

    atlListEl.appendChild(row);
  }
}

// Open modal for a recipe
async function openAddToListModal(recipe){
  atlRecipe = recipe || null;
  atlBasePortions = (recipe && recipe.basePortions) ? Number(recipe.basePortions) : 2;
  atlServings = recipe && recipe.lastUsedServings ? Number(recipe.lastUsedServings) : atlBasePortions;

  // Load ingredients from the recipe subcollection fresh (authoritative)
  atlIngredients = [];
  try{
    const qs = await db.collection('recipes').doc(household)
      .collection('recipes').doc(recipe.id).collection('ingredients').get();
    qs.forEach(d => {
      const x = d.data() || {};
      atlIngredients.push({
        name: x.name || '',
        nameKey: (x.nameKey || (x.name||'')).toLowerCase(),
        qty: x.qty || '',
        size: x.size || '',
        notes: x.notes || ''
      });
    });
  } catch(e){
    console.warn('Failed to load recipe ingredients:', e.message||e);
  }

  // Reset UI
  atlServingsEl.value = atlServings;
  if (atlSelectAll) atlSelectAll.checked = true;
  renderAtlList();

  addToListModal.classList.add('show');
  addToListModal.setAttribute('aria-hidden','false');
  atlServingsEl.focus();
}

function closeAddToListModal(){
  addToListModal.classList.remove('show');
  addToListModal.setAttribute('aria-hidden','true');
}

// wire close
if (atlClose) atlClose.onclick = closeAddToListModal;

// servings +/- buttons
if (atlInc) atlInc.onclick = () => {
  atlServings = Math.max(1, Number(atlServingsEl.value||atlServings) + 1);
  atlServingsEl.value = atlServings;
  renderAtlList();
};
if (atlDec) atlDec.onclick = () => {
  atlServings = Math.max(1, Number(atlServingsEl.value||atlServings) - 1);
  atlServingsEl.value = atlServings;
  renderAtlList();
};

// presets (1×, 1.5×, 2× relative to base portions)
atlPresets.forEach(btn=>{
  btn.onclick = () => {
    const mult = parseFloat(btn.dataset.x);
    if (!Number.isFinite(mult)) return;
    atlServings = Math.max(1, Math.round(atlBasePortions * mult));
    atlServingsEl.value = atlServings;
    renderAtlList();
    // simple visual state
    atlPresets.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  };
});

// keyboard ↑/↓ in servings
if (atlServingsEl){
  atlServingsEl.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowUp'){ e.preventDefault(); atlInc.click(); }
    if (e.key === 'ArrowDown'){ e.preventDefault(); atlDec.click(); }
  });
  atlServingsEl.addEventListener('change', ()=>{
    const v = parseInt(atlServingsEl.value||atlServings, 10);
    atlServings = Number.isFinite(v) && v>0 ? v : atlServings;
    atlServingsEl.value = atlServings;
    renderAtlList();
  });
}

// select/deselect all
if (atlSelectAll){
  atlSelectAll.onchange = () => {
    document.querySelectorAll('#atlList .checkrow input[type="checkbox"]').forEach(cb=>{
      cb.checked = atlSelectAll.checked;
    });
  };
}

// Commit: add selected ingredients (merged) to shopping list
if (atlAddBtn) atlAddBtn.onclick = async () => {
  if (!auth || !auth.currentUser || !household) { alert('Sign in and set the household first.'); return; }
  try{
    const factor = Math.max(1, atlServings) / Math.max(1, atlBasePortions);

    const rows = Array.from(document.querySelectorAll('#atlList .checkrow'));
    const chosen = rows.filter(r => r._cb && r._cb.checked);

    if (!chosen.length){ showToast('Nothing selected'); return; }

    const batch = db.batch();

    for (const row of chosen){
      const ing = row._ing;
      const scaledQty = scaleQtyStr(ing.qty || '', factor);

      // Find existing list item
      const existing = findExistingItem(ing.nameKey || ing.name);
      if (existing){
        // merge qty
        const newQty = addQtyStr(existing.qty || '', scaledQty);
        const ref = db.collection('lists').doc(household).collection('items').doc(existing.id);
        batch.set(ref, {
          qty: newQty,
          // optionally fill size/notes if empty
          size: existing.size || ing.size || '',
          notes: existing.notes || ing.notes || '',
          checked: false, // force it back onto the Shopping list
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } else {
        // new item; pull category/route from catalogCache if available
        const catKnown = catalogCache.get((ing.name||'').toLowerCase()) || {};
        const ref = db.collection('lists').doc(household).collection('items').doc();
        batch.set(ref, {
          name: ing.name,
          qty: scaledQty,
          size: ing.size || '',
          notes: ing.notes || '',
          category: catKnown.category || '',
          routeOrder: (catKnown.routeOrder === 0 || catKnown.routeOrder) ? catKnown.routeOrder : '',
          checked: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    // Update recipe lastUsedServings
    if (atlRecipe && atlRecipe.id){
      const rref = db.collection('recipes').doc(household).collection('recipes').doc(atlRecipe.id);
      batch.set(rref, {
        lastUsedServings: atlServings,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: (auth.currentUser.email || auth.currentUser.uid || 'unknown')
      }, { merge: true });
    }

    await batch.commit();
    showToast('Added to shopping list');
    closeAddToListModal();
  } catch(e){
    console.error(e);
    alert('Add failed: ' + (e.message || e));
  }
};

  </script>

  <script>
    // Subtle haptic on taps
    document.addEventListener('pointerdown', (e) => {
      const btn = e.target.closest('button,[role="button"]');
      if (!btn) return;
      if (btn.dataset && btn.dataset.haptic === 'off') return;
      if (navigator.vibrate) navigator.vibrate(10);
    });
  </script>
  <script>
    // Press animation on rows
    document.addEventListener('pointerdown', (e) => { const row = e.target.closest('.item'); if (row) row.classList.add('is-pressed'); });
    const clearPress = () => { document.querySelectorAll('.item.is-pressed').forEach(r => r.classList.remove('is-pressed')); };
    document.addEventListener('pointerup', clearPress);
    document.addEventListener('pointercancel', clearPress);
  </script>
  <script>
    // Minimal toast helper
    (function(){
      const t = document.createElement('div');
      t.id = 'toast'; t.className = 'toast';
      document.body.appendChild(t);
      window.showToast = (msg) => {
        t.textContent = msg; t.classList.add('show');
        clearTimeout(t._hide); t._hide = setTimeout(() => t.classList.remove('show'), 1600);
      };
    })();
  </script>
  <script>
    // Lightbox
    (function(){
      const lb = document.createElement('div');
      lb.className = 'lightbox';
      lb.innerHTML = '<img alt=""><button class="close" aria-label="Close">×</button>';
      document.body.appendChild(lb);
      const img = lb.querySelector('img');
      const close = () => lb.classList.remove('show');
      lb.addEventListener('click', (e)=>{ if (e.target===lb || e.target.classList.contains('close')) close(); });
      window.openLightbox = (src) => { img.src = src; lb.classList.add('show'); };
    })();
  </script>
  <script>
    // Enter key = Add
    (['itemName','itemQty','itemSize','itemCategory','itemRoute','itemNotes']).forEach(id => {
      const n = document.getElementById(id); if (!n) return;
      n.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.isComposing) { e.preventDefault(); const addBtn = document.getElementById('add'); if (addBtn) addBtn.click(); }
      });
    });
  </script>
  <!-- Bottom navigation (place this just above the theme script) -->
<nav class="bottom-nav" id="bottomNav">
  <button id="tabList" class="tab" type="button">List</button>
  <button id="tabShopping" class="tab" type="button">Shopping</button>
  <button id="tabRecipes" class="tab" type="button">Recipes</button>
</nav>

<!-- Floating theme toggle (moved out of the nav) -->
<button id="themeToggle" class="theme-fab" type="button" aria-label="Toggle theme">🌙 Dark</button>

<script>
  // One listener to handle clicks on any of the three nav buttons
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#tabList, #tabShopping, #tabRecipes');
    if (!btn) return;

    const idToTab = {
      tabList: 'list',
      tabShopping: 'shopping',
      tabRecipes: 'recipes'
    };
    const tab = idToTab[btn.id];
    if (!tab) return;

    // Visual state
    document.querySelectorAll('.bottom-nav .tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Persist + render using your existing function
    localStorage.setItem('activeTab', tab);
    if (typeof setActiveTab === 'function') {
      setActiveTab(tab);
    }
  });

  // Sync the active highlight on page load
  (function syncBottomNav(){
    const current = localStorage.getItem('activeTab') || 'list';
    const el = {
      list: document.getElementById('tabList'),
      shopping: document.getElementById('tabShopping'),
      recipes: document.getElementById('tabRecipes')
    }[current];
    if (el) el.classList.add('active');
  })();
</script>


    // Use the app's existing setActiveTab for logic/render,
    // and update the visual "active" class here.
    if (typeof setActiveTab === 'function') {
      if (list) list.addEventListener('click', () => { setActiveClasses('list');     setActiveTab('list'); });
      if (shop) shop.addEventListener('click', () => { setActiveClasses('shopping'); setActiveTab('shopping'); });
      if (rec)  rec.addEventListener('click',  () => { setActiveClasses('recipes');  setActiveTab('recipes'); });
    }

    // Sync the highlight on load (the earlier call to setActiveTab ran before the nav existed)
    const saved = localStorage.getItem('activeTab') || 'list';
    setActiveClasses(saved);
  })();
</script>

  <script>
const root = document.documentElement;
const btn = document.getElementById('themeToggle');

// On load: check saved theme
const saved = localStorage.getItem('theme');
if (saved === 'dark') {
  root.setAttribute('data-theme', 'dark');
  btn.textContent = '☀️ Light';
} else {
  root.setAttribute('data-theme', 'light');
  btn.textContent = '🌙 Dark';
}

// Toggle on click
btn.onclick = () => {
  const current = root.getAttribute('data-theme');
  if (current === 'dark') {
    root.setAttribute('data-theme', 'light');
    localStorage.setItem('theme', 'light');
    btn.textContent = '🌙 Dark';
  } else {
    root.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
    btn.textContent = '☀️ Light';
  }
};
</script>
<nav class="bottom-nav">
  <button id="tabList" class="tab active" type="button">List</button>
  <button id="tabShopping" class="tab" type="button">Shopping</button>
  <button id="tabRecipes" class="tab" type="button">Recipes</button>
</nav>

</body>
</html>
